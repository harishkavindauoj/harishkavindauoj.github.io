name: Update Portfolio

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:

jobs:
  update-portfolio:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Update portfolio
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GOOGLE_DRIVE_API_KEY: ${{ secrets.GOOGLE_DRIVE_API_KEY }}
        GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}  # Your Google Drive folder ID containing videos
      run: |
        curl -s -H "Authorization: token $GITHUB_TOKEN" \
             -H "Accept: application/vnd.github.v3+json" \
             "https://api.github.com/users/harishkavindauoj/repos?sort=updated&per_page=50" \
             > repos.json
        
        cat > update.js << 'EOF'
        const fs = require('fs');
        const https = require('https');

        const GITHUB_REPOS = JSON.parse(fs.readFileSync('repos.json', 'utf8'));
        const API_KEY = process.env.GOOGLE_DRIVE_API_KEY;
        const FOLDER_ID = process.env.GOOGLE_DRIVE_FOLDER_ID;

        let html = fs.readFileSync('index.html', 'utf8');

        function fetchDriveVideos() {
          if (!API_KEY || !FOLDER_ID) {
            console.log('Google Drive API credentials missing, skipping video fetch');
            return Promise.resolve([]);
          }

          // Fetch files from Google Drive folder
          const url = `https://www.googleapis.com/drive/v3/files?key=${API_KEY}&q='${FOLDER_ID}'+in+parents+and+mimeType+contains+'video'&fields=files(id,name,webViewLink,webContentLink,thumbnailLink,videoMediaMetadata)&pageSize=100`;
          
          return new Promise((resolve, reject) => {
            console.log('Fetching Google Drive videos...');
            
            https.get(url, res => {
              let data = '';
              res.on('data', chunk => data += chunk);
              res.on('end', () => {
                try {
                  const json = JSON.parse(data);
                  
                  if (json.error) {
                    console.error('Google Drive API Error:', json.error.message);
                    resolve([]);
                    return;
                  }
                  
                  const videos = json.files || [];
                  console.log(`Found ${videos.length} videos in Google Drive folder`);
                  
                  // Log video names for debugging
                  videos.forEach((video, index) => {
                    console.log(`Video ${index + 1}: ${video.name}`);
                  });
                  
                  resolve(videos);
                } catch (err) {
                  console.error('Error parsing Google Drive response:', err.message);
                  resolve([]);
                }
              });
            }).on('error', err => {
              console.error('Error fetching Google Drive videos:', err.message);
              resolve([]);
            });
          });
        }

        function formatRepoName(name) {
          return name
            .replace(/[-_]/g, ' ')
            .split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
        }

        function findMatchingVideo(repoName, videos) {
          const searchTerms = [
            repoName.toLowerCase(),
            repoName.replace(/[-_]/g, ' ').toLowerCase(),
            repoName.replace(/[-_]/g, '').toLowerCase()
          ];
          
          for (const term of searchTerms) {
            const match = videos.find(video => {
              const fileName = video.name?.toLowerCase() || '';
              
              return fileName.includes(term) || 
                     fileName.replace(/[-_]/g, ' ').includes(term) ||
                     fileName.replace(/[-_]/g, '').includes(term);
            });
            
            if (match) {
              console.log(`Found matching video for ${repoName}: ${match.name}`);
              return match;
            }
          }
          
          console.log(`No matching video found for ${repoName}`);
          return null;
        }

        function getVideoEmbedUrl(fileId) {
          // Create embeddable Google Drive video URL
          return `https://drive.google.com/file/d/${fileId}/preview`;
        }

        (async () => {
          try {
            const driveVideos = await fetchDriveVideos();

            const repos = GITHUB_REPOS
              .filter(repo => !repo.fork && !repo.private && repo.description && repo.description.length > 10 &&
                              !repo.name.includes('.github.io') &&
                              !repo.name.toLowerCase().includes('config') &&
                              !repo.name.toLowerCase().includes('readme'))
              .sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at))
              .slice(0, 5);

            console.log(`Found ${repos.length} repositories to display:`);

            let projectCards = '';
            for (const repo of repos) {
              const name = formatRepoName(repo.name);
              const description = repo.description;
              const date = new Date(repo.updated_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
              });

              console.log(`Processing repo: ${repo.name} (${repo.stargazers_count} stars)`);

              // Find matching video with improved logic
              const matchedVideo = findMatchingVideo(repo.name, driveVideos);

              let videoEmbed = '';
              if (matchedVideo && matchedVideo.id) {
                const embedUrl = getVideoEmbedUrl(matchedVideo.id);
                console.log(`Adding Google Drive embed for ${repo.name}: ${matchedVideo.id}`);
                videoEmbed = `
                  <div class="video-container">
                    <iframe width="100%" height="200" 
                      src="${embedUrl}" 
                      frameborder="0" 
                      allow="autoplay; encrypted-media" 
                      allowfullscreen 
                      style="border-radius: 8px; margin: 10px 0;">
                    </iframe>
                    <div class="video-info" style="font-size: 12px; color: #888; margin-top: 5px;">
                      üìπ ${matchedVideo.name}
                    </div>
                  </div>`;
              } else {
                // Fallback placeholder
                console.log(`No video found for ${repo.name}, showing placeholder`);
                videoEmbed = `
                  <div class="video-placeholder" style="width: 100%; height: 200px; background: linear-gradient(135deg, #1a1a1a, #2a2a2a); border-radius: 8px; margin: 10px 0; display: flex; align-items: center; justify-content: center; color: #666;">
                    <div style="text-align: center;">
                      <div style="font-size: 48px; margin-bottom: 10px;">üé¨</div>
                      <div>Demo video coming soon</div>
                    </div>
                  </div>`;
              }

              projectCards += `
                <div class="project-card">
                  <div class="project-content">
                    <h3><a href="${repo.html_url}" target="_blank" style="color: #ffd700; text-decoration: none;">${name}</a></h3>
                    <p>${description}</p>
                    <div class="project-video">${videoEmbed}</div>
                    <div class="project-stats">
                      <span>‚≠ê ${repo.stargazers_count}</span>
                      <span>üìÖ ${date}</span>
                      ${repo.language ? `<span>üíª ${repo.language}</span>` : ''}
                    </div>
                  </div>
                </div>`;
            }

            projectCards += `
                <div class="project-card">
                  <div class="project-content" style="display: flex; justify-content: center; align-items: center; height: 180px;">
                    <h3><a href="https://github.com/harishkavindauoj?tab=repositories" target="_blank" style="font-size: 4rem; color: #ffd700; text-decoration: none;">See More..</a></h3>
                  </div>
                </div>`;

            const regex = /<div class="project-cards">[\s\S]*?<\/div>/;
            const replacement = `<div class="project-cards">${projectCards}</div>`;
            html = html.replace(regex, replacement);

            const now = new Date().toLocaleString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              timeZone: 'Asia/Colombo',
              timeZoneName: 'short'
            });

            const metadataHtml = `<div class="portfolio-metadata">Last updated: <span class="last-updated">${now}</span></div>`;
            if (html.includes('portfolio-metadata')) {
              html = html.replace(/<div class="portfolio-metadata">.*?<\/div>/, metadataHtml);
            } else {
              html = html.replace(/(<footer)/, `${metadataHtml}\n\n    $1`);
            }

            fs.writeFileSync('index.html', html);
            console.log('Portfolio updated successfully!');
            
          } catch (error) {
            console.error('Error updating portfolio:', error.message);
            console.error('Stack trace:', error.stack);
            process.exit(1);
          }
        })();
        EOF

        node update.js
        
        rm repos.json update.js

    - name: Check for changes
      id: check-changes
      run: |
        if git diff --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit changes
      if: steps.check-changes.outputs.changed == 'true'
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        git add index.html
        git commit -m "ü§ñ Auto-update portfolio with latest projects"
        git push
