name: Update Portfolio

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:

jobs:
  update-portfolio:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Update portfolio
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Fetch repositories
        REPOS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/users/harishkavindauoj/repos?sort=updated&per_page=100")
        
        # Create temporary Node.js script
        node -e "
        const fs = require('fs');
        
        // Read HTML file
        let html = fs.readFileSync('index.html', 'utf8');
        
        // Parse repos from stdin
        const allRepos = JSON.parse(process.env.REPOS || '[]');
        
        // Filter repositories
        const repos = allRepos
          .filter(repo => 
            !repo.fork && 
            !repo.private && 
            repo.description && 
            !repo.name.includes('.github.io') &&
            !repo.name.includes('config')
          )
          .sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at))
          .slice(0, 3);
        
        // Generate project cards
        let projectCards = '';
        repos.forEach(repo => {
          const name = repo.name.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          const date = new Date(repo.updated_at).toLocaleDateString();
          
          projectCards += \`
                <div class=\"project-card\">
                    <div class=\"project-content\">
                        <h3><a href=\"\${repo.html_url}\" target=\"_blank\" style=\"color: #ffd700; text-decoration: none;\">\${name}</a></h3>
                        <p>\${repo.description}</p>
                        <div class=\"project-stats\">
                            <span>‚≠ê \${repo.stargazers_count}</span>
                            <span>üìÖ \${date}</span>
                        </div>
                    </div>
                </div>\`;
        });
        
        // Add See More card
        projectCards += \`
                <div class=\"project-card\">
                    <div class=\"project-content\" style=\"display: flex; justify-content: center; align-items: center; height: 180px;\">
                        <h3><a href=\"https://github.com/harishkavindauoj?tab=repositories\" target=\"_blank\" style=\"font-size: 4rem; color: #ffd700; text-decoration: none;\">See More..</a></h3>
                    </div>
                </div>\`;
        
        // Replace in HTML
        const regex = /<div class=\"project-cards\">[\s\S]*?<\/div>/;
        html = html.replace(regex, \`<div class=\"project-cards\">\${projectCards}
            </div>\`);
        
        // Write back
        fs.writeFileSync('index.html', html);
        console.log('Portfolio updated successfully!');
        " REPOS="$REPOS"
    
    - name: Check for changes
      id: check-changes
      run: |
        if git diff --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit changes
      if: steps.check-changes.outputs.changed == 'true'
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        git add index.html
        git commit -m "ü§ñ Auto-update portfolio with latest projects"
        git push
